name: PublishPackage

on:
  workflow_dispatch:
  release:
    types: [published]


jobs:
  package:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install dependencies
      run: lein deps
    - name: Run clj test
      run: lein test
    - name: Generate pom.xml needed for mvn deploy
      run: lein pom
    - name: Deploy to Github Package Registry
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir -p ~/.m2
        echo "<settings><servers><server><id>github</id><username>$(echo "$GITHUB_REPOSITORY" | awk -F / '{print $1}')</username><password>\${env.GITHUB_TOKEN}</password></server></servers></settings>" > ~/.m2/settings.xml
        mvn deploy
    - name: Slack Notification
      if: ${{ success() }}
      uses: rtCamp/action-slack-notify@v2.1.0
      env:
        SLACK_CHANNEL: releases
        SLACK_FOOTER: Fractl Release Notification
        SLACK_TITLE: 'Release packaging successful'
        SLACK_MESSAGE: ${{ github.event.release.tag_name }}
        SLACK_USERNAME: Release Bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    - name: Slack Notification
      if: ${{ failure() }}
      uses: rtCamp/action-slack-notify@v2.1.0
      env:
        SLACK_CHANNEL: releases
        SLACK_FOOTER: Fractl Release Notification
        SLACK_TITLE: 'Release packaging failed'
        SLACK_MESSAGE: ${{ github.event.release.tag_name }}
        SLACK_COLOR: '#ff1100'
        SLACK_USERNAME: Release Bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
